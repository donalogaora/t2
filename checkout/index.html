<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>Checkout | Dónal Ó Gaora</title>
		<script async src="https://www.googletagmanager.com/gtag/js?id=G-5T6LYNY6K9"></script>
		<script>
			window.dataLayer = window.dataLayer || [];
			function gtag(){dataLayer.push(arguments);}
			gtag('js', new Date());
			gtag('config', 'G-5T6LYNY6K9');
		</script>
		<meta name="description" content="Checkout any product from shop.donalogaora.com here!">
		<meta name="keywords" content="Dónal Ó Gaora, donalogaora, online shop, email, PayPal, 3D prints, 3D printed, custom, postage, delivery, cart, checkout">
		<meta name="author" content="Dónal Ó Gaora">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta property="og:title" content="Checkout | Dónal Ó Gaora">
		<meta property="og:description" content="Checkout any product from shop.donalogaora.com here!">
		<meta property="og:image" content="https://shop.donalogaora.com/assets/dog.webp">
		<meta property="og:url" content="https://shop.donalogaora.com/checkout">
		<meta property="og:type" content="website">
		<meta name="twitter:card" content="summary_large_image">
		<meta name="twitter:title" content="Checkout | Dónal Ó Gaora">
		<meta name="twitter:description" content="Checkout any product from shop.donalogaora.com here!">
		<meta name="twitter:image" content="https://shop.donalogaora.com/assets/dog.webp">
		<link rel="canonical" href="https://shop.donalogaora.com/checkout">
		<link rel="apple-touch-icon" sizes="180x180" href="assets/favicon.ico/apple-touch-icon.png" />
		<link rel="icon" type="image/png" sizes="32x32" href="../assets/favicon.ico/favicon-32x32.png" />
		<link rel="icon" type="image/png" sizes="16x16" href="../assets/favicon.ico/favicon-16x16.png" />
		<link rel="manifest" href="../assets/favicon.ico/site.webmanifest" />
		<link rel="icon" href="../assets/favicon.ico/favicon.ico" type="image/x-icon" />
		<link href="../style.css" rel="stylesheet" type="text/css" />
	</head>
	<body>
		<ul class="nav-bar">
			<li>
				<a href="https://home.donalogaora.com" class="page-other">Home</a>
			</li>
			<li>
				<a href="https://t2.donalogaora.com" class="page-other">Shop</a>
			</li>
			<li>
				<a href="https://t2.donalogaora.com/checkout" class="page-current">Cart</a>
			</li>
		</ul>
		<!--
		<ul class="nav-bar">
			<li>
				<a href="https://www.donalogaora.com" class="page-other">Home</a>
			</li>
			<li>
				<a href="https://shop.donalogaora.com" class="page-other">Shop</a>
			</li>
			<li>
				<a href="https://shop.donalogaora.com/checkout" class="page-current">Cart</a>
			</li>
		</ul>
		-->
		<br>
		
		
		<div class="box-wrapper-700">
			<script src="https://www.paypal.com/sdk/js?client-id=AQXn0djWlFNUVFdtyT8C650WfsHSAGDTfttNhrwoiGqFdCUy6nrPJHmFjGoJ__lwTN4WxbQNEGI1aUkX&currency=EUR"></script>
			<div class="cart">
				<h2 class="text-3-1">Your Cart</h2>
				<ul 
				    id="cart-items" 
				    class="product-description" 
				    style="
					font-weight: bold;
					font-size: 18px;
					color: #6e6d68;
					-webkit-text-stroke: 1px #24252b;
					margin: 10px 0;
				    "
				></ul>
				<p class="text-3-4">Total: €<span>0.00</span></p>

				<p class="text-3-2">
				  <strong>Note:</strong> Postage starts at €4.50, it is added on during payment process.
				</p>
			  </div>
			  <div id="paypal-button-container"></div>
			  <script>
				let cart = JSON.parse(localStorage.getItem('cart')) || [];
				const BACKEND_URL = 'https://api-shop-checkout.donalogaora.com';
			  
				async function fetchPostage(subtotal) {
				  try {
					const response = await fetch(`${BACKEND_URL}/calculate-postage`, {
					  method: 'POST',
					  headers: { 'Content-Type': 'application/json' },
					  body: JSON.stringify({ subtotal })
					});
					const data = await response.json();
					return data.postage ?? 0;
				  } catch (err) {
					console.error('Postage fetch failed', err);
					return 0;
				  }
				}
			  
				async function renderCart() {
				  const cartItemsContainer = document.getElementById('cart-items');
				  const totalEl = document.querySelector('.text-3-4 span');
			  
				  if (!cartItemsContainer) return;
			  
				  if (cart.length === 0) {
					cartItemsContainer.innerHTML = '<p class="empty-message">Your cart is empty.</p>';
					totalEl.textContent = '0.00';
					return;
				  }
			  
				  cartItemsContainer.innerHTML = '';
				  let subtotal = 0;
			  
				  cart.forEach(item => {
					const li = document.createElement('li');
					li.innerHTML = `
					  <img src="${item.image || ''}" alt="${item.name} - ${item.colour}">
					  <div class="item-details">
						<div class="product-description-bold">${item.name}</div>
						<div class="product-description" style="
						  font-weight: bold;
						  font-size: 15px;
						  color: #6e6d68;
						  -webkit-text-stroke: 0.7px #24252b;
						  margin: 10px 0;
						">Colour: ${item.colour}</div>
						<div class="product-description" style="
						  font-weight: bold;
						  font-size: 15px;
						  color: #6e6d68;
						  -webkit-text-stroke: 0.7px #24252b;
						  margin: 10px 0;
						">Price: €${item.price.toFixed(2)} x ${item.qty}</div>
					  </div>
					  <button class="remove-btn" data-id="${item.id}" data-colour="${item.colour}">Remove</button>
					`;
					cartItemsContainer.appendChild(li);
					subtotal += item.price * item.qty;
				  });
			  
				  const postage = await fetchPostage(subtotal);
				  const total = subtotal + postage;
			
				  totalEl.textContent = total.toFixed(2);
				}
			  
				document.getElementById('cart-items').addEventListener('click', (event) => {
				  if (event.target.classList.contains('remove-btn')) {
					const id = event.target.getAttribute('data-id');
					const colour = event.target.getAttribute('data-colour');
				
					// Find the item index
					const index = cart.findIndex(item => item.id === id && item.colour === colour);
					if (index > -1) {
					  if (cart[index].qty > 1) {
						cart[index].qty -= 1;  // Just reduce qty by 1
					  } else {
						cart.splice(index, 1);  // Remove item if qty reaches 0
					  }
					  localStorage.setItem('cart', JSON.stringify(cart));
					  renderCart();
					}
				  }
				});
				
				const promoCodes = JSON.parse(localStorage.getItem('promoCodes')) || []; //['WELCOME', 'HI10']
				//const promoCodes = ['WELCOME10', 'FREESHIP'];
			  
				paypal.Buttons({
				  createOrder: function(data, actions) {
					const orderItems = cart.map(item => ({
					  productId: item.id,
					  quantity: item.qty,
					  colour: item.colour, // include colour here
					  material: item.material
					}));
			  
					return fetch(`${BACKEND_URL}/create-order`, {
					  method: 'POST',
					  headers: { 'Content-Type': 'application/json' },
					  body: JSON.stringify({
					    items: orderItems,
						promoCodes
					  })
					})
					.then(res => res.json())
					.then(data => {
					  if (!data.id) throw new Error('No order ID from backend');
					  return data.id;
					});
				  },
			  
				  onApprove: function(data) {
					return fetch(`${BACKEND_URL}/capture-order`, {
					  method: 'POST',
					  headers: { 'Content-Type': 'application/json' },
					  body: JSON.stringify({ orderId: data.orderID })
					})
					.then(res => res.json())
					.then(details => {
					  if (details.status === 'COMPLETED') {
						alert(`Thank you, ${details.payer.name.given_name}! Your order is confirmed.`);
						localStorage.removeItem('cart');
						window.location.href = `thank-you/index.html?name=${encodeURIComponent(details.payer.name.given_name)}`;
					  } else {
						alert('Payment not completed');
					  }
					})
					.catch(err => {
					  console.error(err);
					  alert('Payment failed. Please try again.');
					});
				  },
			  
				  onError: function(err) {
					console.error('PayPal error', err);
					alert('An error occurred with PayPal.');
				  }
				}).render('#paypal-button-container');
			  
				renderCart();
			  </script>
		</div>
		<div class="footer-spacer" aria-hidden="true"></div>
		<footer class="footer footer--tc">
			<span class="text-6">
				shop.donalogaora.com
				<a href="https://shop.donalogaora.com/terms-and-conditions" class="text-6-1" target="_blank">T&Cs</a>
			</span>
			<br>
			<span class="text-6">
				© 2025
				<a href="https://www.github.com/donalogaora" class="text-6-1" target="_blank">Dónal Ó Gaora</a>. All Rights Reserved.
			</span>
			<br>
			<span class="text-6">
				Designed by
				<a href="https://www.github.com/donalogaora" class="text-6-1" target="_blank">
				Dónal Ó Gaora
				</a>
			</span>
		</footer>
	</body>
</html>
